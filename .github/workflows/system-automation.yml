
name: System Automation Workflow

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # --- Construye y genera artifacts en Ubuntu y Windows ---
  build:
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest ]
    runs-on: ${{ matrix.os }}

    steps:
      # 1) Clonar el repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Variables de entorno "persistentes" para los siguientes pasos
      - name: Set environment variables
        run: |
          echo "MY_VAR=HelloWorld" >> "$GITHUB_ENV"

      # 3a) Script en Bash (Linux) con manejo de errores y secreto seguro
      - name: Run automation script (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        env:
          SECRET_TOKEN: ${{ secrets.SECRET_TOKEN }}   # <-- secreto solo para este paso
          OS_NAME: ${{ matrix.os }}
        run: |
          set -euo pipefail
          echo "=== Inicio Linux ==="
          
          # Leer/escribir archivos
          echo "Contenido generado por workflow en Linux" > "output-${OS_NAME}.txt"

          # Permisos (chmod)
          chmod 644 "output-${OS_NAME}.txt"

          # Proceso en segundo plano
          ( sleep 3 && echo "BG Linux listo" > "bg-${OS_NAME}.log" ) &

          # Validar secreto sin romper por 'nounset'
          if [ -z "${SECRET_TOKEN:-}" ]; then
            echo "Falta SECRET_TOKEN"; exit 1;
          fi

          # Usar variable de entorno
          echo "Var: ${MY_VAR:-}"

          # Esperar procesos en segundo plano (si fallan, no romper)
          wait || true

          # Info de permisos
          stat -c '%A %n' "output-${OS_NAME}.txt" > "perms-${OS_NAME}.txt"

          # Directorio de artifacts
          mkdir -p "artifacts-${OS_NAME}"
          cp -v "output-${OS_NAME}.txt" "bg-${OS_NAME}.log" "perms-${OS_NAME}.txt" "artifacts-${OS_NAME}/"

          echo "=== Fin Linux ==="

      # 3b) Script en PowerShell (Windows) con manejo de errores y secreto seguro
      - name: Run automation script (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        env:
          SECRET_TOKEN: ${{ secrets.SECRET_TOKEN }}   # <-- secreto solo para este paso
          OS_NAME: ${{ matrix.os }}
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "=== Inicio Windows ==="

          # Leer/escribir archivos
          "Contenido generado por workflow en Windows" | Set-Content -Path "output-$env:OS_NAME.txt" -Encoding UTF8

          # Permisos (icacls) - ejemplo: lectura para Users (SID 545)
          icacls ".\output-$env:OS_NAME.txt" /grant "*S-1-5-32-545:(R)" | Out-Host

          # Proceso en segundo plano
          Start-Job -ScriptBlock {
            Start-Sleep -Seconds 3
            "BG Windows listo" | Set-Content -Path "bg-$env:OS_NAME.log" -Encoding UTF8
          } | Out-Null

          # Validar secreto
          if (-not $env:SECRET_TOKEN) {
            Write-Error "Falta SECRET_TOKEN"; exit 1
          }

          # Usar variable de entorno
          Write-Host "Var: $env:MY_VAR"

          # Esperar el job de fondo
          Get-Job | Wait-Job | Receive-Job | Out-Null
          Get-Job | Remove-Job -Force

          # Info de permisos
          $acl = Get-Acl ".\output-$env:OS_NAME.txt"
          "Permisos: $($acl.AccessToString)" | Set-Content -Path "perms-$env:OS_NAME.txt" -Encoding UTF8

          # Directorio de artifacts
          New-Item -ItemType Directory -Force -Path "artifacts-$env:OS_NAME" | Out-Null
          Copy-Item "output-$env:OS_NAME.txt","bg-$env:OS_NAME.log","perms-$env:OS_NAME.txt" -Destination "artifacts-$env:OS_NAME" -Force

          Write-Host "=== Fin Windows ==="

      # 4) Subir artifacts (v4). Nombre único por sistema operativo.
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: system-automation-${{ matrix.os }}   # nombre único en la corrida
          path: artifacts-${{ matrix.os }}
          if-no-files-found: error
          retention-days: 14

  # --- Job de verificación: descarga y valida todos los artifacts ---
  verify:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts (merged)
        uses: actions/download-artifact@v4
        with:
          pattern: system-automation-*   # descarga múltiples artifacts por patrón
          merge-multiple: true           # los fusiona en un solo directorio
          path: merged

      - name: List downloaded files
        run: |
          echo "=== Archivos descargados ==="
          ls -R merged

      - name: Validate contents & exit codes
        shell: bash
        run: |
          set -euo pipefail
          cd merged
          # Validaciones mínimas (muestran exit codes si falla)
          test -f output-ubuntu-latest.txt || { echo "Falta output-ubuntu-latest.txt"; exit 2; }
          test -f output-windows-latest.txt || { echo "Falta output-windows-latest.txt"; exit 3; }
          # Verificar que existan logs de background
          ls bg-*.log >/dev/null 2>&1 || { echo "Faltan logs de background"; exit 4; }
          echo "Verificación OK"

