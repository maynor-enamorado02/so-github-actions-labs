name: Advanced System Automation

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'

env:
  WORKING_DIR: './automation-workspace'
  ARTIFACTS_DIR: './artifacts'

jobs:
  system-automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup workspace
      run: |
        mkdir -p ${{ env.WORKING_DIR }}
        mkdir -p ${{ env.ARTIFACTS_DIR }}
    
    - name: Create script file
      run: |
        cd ${{ env.WORKING_DIR }}
        
        # Crear el script en un archivo separado primero
        cat > script-content.sh << 'CONTENT_EOF'
#!/bin/bash
set -e

echo "=== SYSTEM AUTOMATION STARTED ==="
echo "Environment: $1"
echo "Working dir: $(pwd)"
echo "User: $(whoami)"
echo ""

echo "Creating directory structure..."
mkdir -p config logs

echo "Performing file operations..."
echo "environment: $1" > config/system.conf
echo "timestamp: $(date)" >> config/system.conf

echo "Managing permissions..."
chmod 755 automation-script.sh
chmod 644 config/system.conf

echo "Generating system artifacts..."
uname -a > ../artifacts/system_info.txt
df -h > ../artifacts/disk_usage.txt
ps aux > ../artifacts/process_list.txt

echo "=== AUTOMATION COMPLETED SUCCESSFULLY ==="
CONTENT_EOF
        
        # Mover el contenido al script final
        mv script-content.sh automation-script.sh
        chmod +x automation-script.sh
    
    - name: Run automation
      run: |
        cd ${{ env.WORKING_DIR }}
        ./automation-script.sh "${{ github.event.inputs.environment }}"
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: automation-output
        path: ${{ env.ARTIFACTS_DIR }}
    
    - name: Cleanup
      run: |
        rm -rf ${{ env.WORKING_DIR }}
        echo "Cleanup completed"
