name: CI Pipeline Multi-OS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-all-platforms:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Create project structure
      run: |
        mkdir -p src tests
        
        # Crear src/__init__.py
        echo "# Package" > src/__init__.py
        
        # Crear src/app.py CORREGIDO
        cat > src/app.py << 'EOF'
import os
from datetime import datetime

class SimpleApp:
    def __init__(self):
        self.data_dir = "data"
        os.makedirs(self.data_dir, exist_ok=True)
    
    def process_data(self, data):
        processed_data = f"PROCESADO: {data} - {datetime.now()}"
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"data_{timestamp}.txt"
        filepath = os.path.join(self.data_dir, filename)
        
        with open(filepath, 'w') as f:
            f.write(processed_data)
        
        return processed_data
    
    def get_statistics(self):
        if not os.path.exists(self.data_dir):
            return {"file_count": 0, "total_size": 0}
        
        files = os.listdir(self.data_dir)
        total_size = 0
        
        for file in files:
            filepath = os.path.join(self.data_dir, file)
            if os.path.isfile(filepath):
                total_size += os.path.getsize(filepath)
        
        return {"file_count": len(files), "total_size_bytes": total_size}

if __name__ == "__main__":
    app = SimpleApp()
    result = app.process_data("Test")
    print("Resultado:", result)
    stats = app.get_statistics()
    print("Stats:", stats)
EOF

        # Crear tests/__init__.py
        echo "# Tests" > tests/__init__.py
        
        # Crear tests/test_app.py
        cat > tests/test_app.py << 'EOF'
import unittest
import tempfile
import shutil
import os
import sys
sys.path.insert(0, 'src')
from app import SimpleApp

class TestSimpleApp(unittest.TestCase):
    def setUp(self):
        self.test_dir = tempfile.mkdtemp()
        self.app = SimpleApp()
        self.app.data_dir = os.path.join(self.test_dir, "test_data")
    
    def tearDown(self):
        shutil.rmtree(self.test_dir)
    
    def test_process_data(self):
        result = self.app.process_data("test")
        self.assertIn("PROCESADO", result)
    
    def test_stats(self):
        self.app.process_data("test")
        stats = self.app.get_statistics()
        self.assertEqual(stats["file_count"], 1)

if __name__ == '__main__':
    unittest.main()
EOF

        echo "pytest" > requirements.txt
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run application test
      run: |
        python -c "
import sys
sys.path.append('src')
from app import SimpleApp
app = SimpleApp()
result = app.process_data('Test CI/CD')
print('âœ… App result:', result)
stats = app.get_statistics()
print('âœ… Stats:', stats)
print('ğŸ‰ Ã‰XITO - APLICACIÃ“N FUNCIONA PERFECTAMENTE')
        "
    
    - name: Run unit tests
      run: |
        python -m pytest tests/ -v

  final-verification:
    name: âœ… Final Verification
    runs-on: ubuntu-latest
    needs: test-all-platforms
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Ultimate test
      run: |
        python -c "
import sys
sys.path.append('src')
from app import SimpleApp
app = SimpleApp()
result = app.process_data('FINAL TEST')
print('ğŸš€ RESULTADO:', result)
stats = app.get_statistics()
print('ğŸ“Š ESTADÃSTICAS:', stats)
print('âœ…âœ…âœ… PROYECTO CI/CD 100% FUNCIONAL âœ…âœ…âœ…')
