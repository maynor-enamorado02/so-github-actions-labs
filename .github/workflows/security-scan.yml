name: Security Scan

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
    
jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install safety bandit pip-audit
    
    - name: Scan dependencies with Safety
      run: |
        echo "=== Safety Dependency Scan ==="
        safety check --full-report --json > safety-report.json || true
        safety check --short-report
    
    - name: Scan dependencies with pip-audit
      run: |
        echo "=== pip-audit Dependency Scan ==="
        pip-audit --desc --json --output pip-audit-report.json || true
        pip-audit --desc
    
    - name: Check for outdated dependencies
      run: |
        echo "=== Outdated Packages ==="
        pip list --outdated
    
    - name: Analyze dependency licenses
      run: |
        echo "=== License Check ==="
        pip install pip-licenses
        pip-licenses --format=json > licenses.json

  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    needs: dependency-scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Bandit
      run: |
        pip install bandit
    
    - name: Run Bandit security scan
      run: |
        echo "=== Bandit Security Scan ==="
        bandit -r src/ -f json -o bandit-report.json -ll || true
        bandit -r src/ -f screen -ll
    
    - name: Check for secrets in code
      run: |
        echo "=== Secrets Detection ==="
        pip install detect-secrets
        detect-secrets scan --all-files > secrets-scan.json || true

  file-permissions:
    name: File Permissions Check
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check file permissions (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        echo "=== File Permissions Check ==="
        find . -type f -name "*.py" -perm /o=w -ls | tee insecure-files-${{ runner.os }}.txt
        find . -type f -name "*.sh" -perm /o=w -ls | tee -a insecure-files-${{ runner.os }}.txt
        
        if [ -s insecure-files-${{ runner.os }}.txt ]; then
          echo "❌ Found files with insecure permissions (world-writable)"
          cat insecure-files-${{ runner.os }}.txt
          exit 1
        else
          echo "✅ No insecure file permissions found"
        fi
    
    - name: Check file permissions (Windows)
      if: runner.os == 'Windows'
      run: |
        echo "=== File Permissions Check (Windows) ==="
        Get-ChildItem -Recurse -Include *.py, *.ps1 | ForEach-Object {
          $acl = Get-Acl $_.FullName
          $access = $acl.Access | Where-Object { $_.FileSystemRights -match "Write" -and $_.IdentityReference -eq "Everyone" }
          if ($access) {
            Write-Host "Insecure permission: $($_.FullName)"
            Add-Content -Path "insecure-files-windows.txt" -Value $_.FullName
          }
        }
        
        if (Test-Path "insecure-files-windows.txt") {
          Get-Content "insecure-files-windows.txt"
          exit 1
        } else {
          echo "✅ No insecure file permissions found"
        }
    
    - name: Check for executable files
      run: |
        echo "=== Executable Files Check ==="
        if [ "$RUNNER_OS" == "Windows" ]; then
          Get-ChildItem -Recurse -Include *.exe, *.bat, *.cmd | ForEach-Object { $_.FullName } | tee executables-${{ runner.os }}.txt
        else
          find . -type f -executable -not -path "./.git/*" | tee executables-${{ runner.os }}.txt
        fi

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t ci-cd-app:latest -f Dockerfile .
    
    - name: Scan Docker image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ci-cd-app:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  upload-security-reports:
    name: Upload Security Reports
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security, file-permissions]
    if: always()
    
    steps:
    - name: Download all security reports
      uses: actions/download-artifact@v3
      with:
        path: security-reports
    
    - name: Compile security summary
      run: |
        echo "=== SECURITY SCAN SUMMARY ===" > security-summary.md
        echo "Scan date: $(date)" >> security-summary.md
        echo "" >> security-summary.md
        
        if [ -f security-reports/safety-report.json ]; then
          echo "✅ Safety dependency scan completed" >> security-summary.md
        else
          echo "❌ Safety scan failed" >> security-summary.md
        fi
        
        if [ -f security-reports/bandit-report.json ]; then
          echo "✅ Bandit security scan completed" >> security-summary.md
        else
          echo "❌ Bandit scan failed" >> security-summary.md
        fi
        
        echo "" >> security-summary.md
        echo "View detailed reports in artifacts" >> security-summary.md
    
    - name: Upload security summary
      uses: actions/upload-artifact@v3
      with:
        name: security-summary
        path: |
          security-summary.md
          security-reports/
